{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 10, "column": 0}, "map": {"version":3,"sources":["file:///D:/conversational-mirror-asd/src/lib/mongodb.ts"],"sourcesContent":["import { MongoClient } from \"mongodb\";\r\n\r\nif (!process.env.MONGODB_URI) {\r\n  throw new Error('Invalid/Missing environment variable: \"MONGODB_URI\"');\r\n}\r\n\r\nconst uri = process.env.MONGODB_URI;\r\nconst options = {};\r\n\r\nlet client;\r\nlet clientPromise: Promise<MongoClient>;\r\n\r\nif (process.env.NODE_ENV === \"development\") {\r\n  let globalWithMongo = global as typeof globalThis & {\r\n    _mongoClientPromise?: Promise<MongoClient>;\r\n  };\r\n\r\n  if (!globalWithMongo._mongoClientPromise) {\r\n    client = new MongoClient(uri, options);\r\n    globalWithMongo._mongoClientPromise = client.connect();\r\n  }\r\n  clientPromise = globalWithMongo._mongoClientPromise;\r\n} else {\r\n  client = new MongoClient(uri, options);\r\n  clientPromise = client.connect();\r\n}\r\n\r\nexport default clientPromise;"],"names":[],"mappings":";;;;AAAA;;AAEA,IAAI,CAAC,QAAQ,GAAG,CAAC,WAAW,EAAE;IAC5B,MAAM,IAAI,MAAM;AAClB;AAEA,MAAM,MAAM,QAAQ,GAAG,CAAC,WAAW;AACnC,MAAM,UAAU,CAAC;AAEjB,IAAI;AACJ,IAAI;AAEJ,wCAA4C;IAC1C,IAAI;IAIJ,IAAI,CAAC,gBAAgB,mBAAmB,EAAE;QACxC,SAAS,IAAI,oKAAW,CAAC,KAAK;QAC9B,gBAAgB,mBAAmB,GAAG,OAAO,OAAO;IACtD;IACA,gBAAgB,gBAAgB,mBAAmB;AACrD;;uCAKe"}},
    {"offset": {"line": 37, "column": 0}, "map": {"version":3,"sources":["file:///D:/conversational-mirror-asd/src/auth.ts"],"sourcesContent":["import NextAuth from \"next-auth\";\r\nimport Credentials from \"next-auth/providers/credentials\";\r\nimport clientPromise from \"@/lib/mongodb\";\r\nimport bcrypt from \"bcryptjs\";\r\n\r\nexport const { handlers, auth, signIn, signOut } = NextAuth({\r\n  providers: [\r\n    Credentials({\r\n      name: \"Credentials\",\r\n      async authorize(credentials) {\r\n        if (!credentials?.email || !credentials?.password) return null;\r\n\r\n        const client = await clientPromise;\r\n        const db = client.db(\"mirrorDB\");\r\n        \r\n        // Find user by email\r\n        const user = await db.collection(\"users\").findOne({ \r\n          email: (credentials.email as string).toLowerCase() \r\n        });\r\n\r\n        if (!user || !user.password) return null;\r\n\r\n        // Verify password\r\n        const isPasswordCorrect = await bcrypt.compare(\r\n          credentials.password as string,\r\n          user.password\r\n        );\r\n\r\n        if (!isPasswordCorrect) return null;\r\n\r\n        // Return the user object with lifeStage included\r\n        // This object is passed to the 'jwt' callback below as 'user'\r\n        return {\r\n          id: user._id.toString(),\r\n          name: user.name,\r\n          email: user.email,\r\n          lifeStage: user.lifeStage, \r\n        };\r\n      },\r\n    }),\r\n  ],\r\n  callbacks: {\r\n    // 1. JWT Callback: Persists the lifeStage into the encrypted token\r\n    async jwt({ token, user }) {\r\n      if (user) {\r\n        token.id = user.id as string;\r\n        token.lifeStage = user.lifeStage;\r\n      }\r\n      return token;\r\n    },\r\n    // 2. Session Callback: Makes the data available to your Server & Client components\r\n    async session({ session, token }) {\r\n      if (session.user) {\r\n        session.user.id = token.id;\r\n        session.user.lifeStage = token.lifeStage as string;\r\n      }\r\n      return session;\r\n    },\r\n  },\r\n  pages: {\r\n    signIn: \"/login\",\r\n  },\r\n  session: {\r\n    strategy: \"jwt\",\r\n  },\r\n});"],"names":[],"mappings":";;;;;;;;;;AAAA;AACA;AAAA;AACA;AACA;;;;;AAEO,MAAM,EAAE,QAAQ,EAAE,IAAI,EAAE,MAAM,EAAE,OAAO,EAAE,GAAG,IAAA,gKAAQ,EAAC;IAC1D,WAAW;QACT,IAAA,qKAAW,EAAC;YACV,MAAM;YACN,MAAM,WAAU,WAAW;gBACzB,IAAI,CAAC,aAAa,SAAS,CAAC,aAAa,UAAU,OAAO;gBAE1D,MAAM,SAAS,MAAM,gIAAa;gBAClC,MAAM,KAAK,OAAO,EAAE,CAAC;gBAErB,qBAAqB;gBACrB,MAAM,OAAO,MAAM,GAAG,UAAU,CAAC,SAAS,OAAO,CAAC;oBAChD,OAAO,AAAC,YAAY,KAAK,CAAY,WAAW;gBAClD;gBAEA,IAAI,CAAC,QAAQ,CAAC,KAAK,QAAQ,EAAE,OAAO;gBAEpC,kBAAkB;gBAClB,MAAM,oBAAoB,MAAM,4IAAM,CAAC,OAAO,CAC5C,YAAY,QAAQ,EACpB,KAAK,QAAQ;gBAGf,IAAI,CAAC,mBAAmB,OAAO;gBAE/B,iDAAiD;gBACjD,8DAA8D;gBAC9D,OAAO;oBACL,IAAI,KAAK,GAAG,CAAC,QAAQ;oBACrB,MAAM,KAAK,IAAI;oBACf,OAAO,KAAK,KAAK;oBACjB,WAAW,KAAK,SAAS;gBAC3B;YACF;QACF;KACD;IACD,WAAW;QACT,mEAAmE;QACnE,MAAM,KAAI,EAAE,KAAK,EAAE,IAAI,EAAE;YACvB,IAAI,MAAM;gBACR,MAAM,EAAE,GAAG,KAAK,EAAE;gBAClB,MAAM,SAAS,GAAG,KAAK,SAAS;YAClC;YACA,OAAO;QACT;QACA,mFAAmF;QACnF,MAAM,SAAQ,EAAE,OAAO,EAAE,KAAK,EAAE;YAC9B,IAAI,QAAQ,IAAI,EAAE;gBAChB,QAAQ,IAAI,CAAC,EAAE,GAAG,MAAM,EAAE;gBAC1B,QAAQ,IAAI,CAAC,SAAS,GAAG,MAAM,SAAS;YAC1C;YACA,OAAO;QACT;IACF;IACA,OAAO;QACL,QAAQ;IACV;IACA,SAAS;QACP,UAAU;IACZ;AACF"}},
    {"offset": {"line": 112, "column": 0}, "map": {"version":3,"sources":["file:///D:/conversational-mirror-asd/src/actions/chat.ts"],"sourcesContent":["\"use server\";\r\n\r\nimport { auth } from \"@/auth\";\r\nimport clientPromise from \"@/lib/mongodb\";\r\nimport { GoogleGenerativeAI, SchemaType } from \"@google/generative-ai\";\r\n\r\nconst delay = (ms: number) => new Promise((res) => setTimeout(res, ms));\r\n\r\n// Define the Schema once to ensure consistent output format\r\nconst responseSchema = {\r\n  type: SchemaType.OBJECT,\r\n  properties: {\r\n    reflection: {\r\n      type: SchemaType.STRING,\r\n      description: \"Analysis of the unspoken social subtext and intent.\",\r\n    },\r\n    reassurance: {\r\n      type: SchemaType.STRING,\r\n      description: \"Validating message to reduce social anxiety/self-blame.\",\r\n    },\r\n    suggestion: {\r\n      type: SchemaType.STRING,\r\n      description: \"A concrete social script or actionable next step.\",\r\n    },\r\n  },\r\n  required: [\"reflection\", \"reassurance\", \"suggestion\"],\r\n};\r\n\r\nexport async function getAiResponse({\r\n  message,\r\n  lifeStage,\r\n  scenarioId,\r\n  scenarioContext,\r\n  isPractice,\r\n  imageBase64\r\n}: ChatParams) {\r\n  const session = await auth();\r\n  if (!session?.user) throw new Error(\"User must be authenticated.\");\r\n\r\n  const apiKey = process.env.GOOGLE_GENERATIVE_AI_API_KEY;\r\n  if (!apiKey) {\r\n    return {\r\n      reflection: \"The mirror is currently disconnected.\",\r\n      reassurance: \"The system cannot find its credentials.\",\r\n      suggestion: \"Check your .env.local file and restart the server.\"\r\n    };\r\n  }\r\n\r\n  const genAI = new GoogleGenerativeAI(apiKey);\r\n  // Using gemini-2.0-flash for optimal speed and multimodal performance\r\n  const model = genAI.getGenerativeModel({ \r\n    model: \"gemini-2.0-flash\",\r\n    // System instruction acts as the primary persona anchor\r\n    systemInstruction: isPractice \r\n      ? `You are a Social Coach. Scenario: ${scenarioId}. Context: ${scenarioContext}.`\r\n      : `You are the 'Social Mirror'. Goal: Explicitly decode subtext for ASD Level 1 users.`\r\n  });\r\n\r\n  try {\r\n    const parts: any[] = [\r\n      { text: `User Life Stage: ${lifeStage}` },\r\n      { text: `Message to Analyze: ${message || \"Please analyze this social artifact.\"}` }\r\n    ];\r\n\r\n    if (imageBase64 && imageBase64.includes(\",\")) {\r\n      parts.push({\r\n        inlineData: { data: imageBase64.split(\",\")[1], mimeType: \"image/png\" }\r\n      });\r\n    }\r\n\r\n    let result;\r\n    let retries = 0;\r\n    const maxRetries = 2;\r\n\r\n    while (retries <= maxRetries) {\r\n      try {\r\n        result = await model.generateContent({\r\n          contents: [{ role: \"user\", parts }],\r\n          generationConfig: { \r\n            responseMimeType: \"application/json\", \r\n            responseSchema: responseSchema, // Forces schema adherence\r\n            temperature: 0.7 \r\n          },\r\n        });\r\n        break; \r\n      } catch (e: any) {\r\n        if (e.status === 429 && retries < maxRetries) {\r\n          retries++;\r\n          await delay(2000 * retries); // Exponential backoff\r\n          continue;\r\n        }\r\n        throw e;\r\n      }\r\n    }\r\n\r\n    const text = result?.response?.text();\r\n    if (!text) throw new Error(\"EMPTY_RESPONSE\");\r\n\r\n    // With responseSchema, the output is guaranteed to be valid JSON\r\n    const data = JSON.parse(text);\r\n\r\n    // PERSISTENCE to the 'Private Vault'\r\n    const client = await clientPromise;\r\n    const db = client.db(\"mirrorDB\"); \r\n    await db.collection(\"chat_history\").insertOne({\r\n      userId: session.user.id,\r\n      lifeStage,\r\n      userMessage: message,\r\n      aiResponse: data,\r\n      timestamp: new Date(),\r\n    });\r\n\r\n    return data;\r\n\r\n  } catch (error: any) {\r\n    console.error(\"Mirror Engine Error:\", error);\r\n    \r\n    if (error.status === 429) {\r\n      return {\r\n        reflection: \"The mirror is overwhelmed by too many requests.\",\r\n        reassurance: \"Just like social situations, sometimes tech needs a break.\",\r\n        suggestion: \"Wait 60 seconds and try again.\"\r\n      };\r\n    }\r\n\r\n    return {\r\n      reflection: \"The mirror is momentarily hazy.\",\r\n      reassurance: \"Social interactions take practice, and so does technology.\",\r\n      suggestion: \"Try rephrasing or refreshing the page.\"\r\n    };\r\n  }\r\n}"],"names":[],"mappings":";;;;;AAEA;AACA;AACA;;;;;;AAEA,MAAM,QAAQ,CAAC,KAAe,IAAI,QAAQ,CAAC,MAAQ,WAAW,KAAK;AAEnE,4DAA4D;AAC5D,MAAM,iBAAiB;IACrB,MAAM,4KAAU,CAAC,MAAM;IACvB,YAAY;QACV,YAAY;YACV,MAAM,4KAAU,CAAC,MAAM;YACvB,aAAa;QACf;QACA,aAAa;YACX,MAAM,4KAAU,CAAC,MAAM;YACvB,aAAa;QACf;QACA,YAAY;YACV,MAAM,4KAAU,CAAC,MAAM;YACvB,aAAa;QACf;IACF;IACA,UAAU;QAAC;QAAc;QAAe;KAAa;AACvD;AAEO,eAAe,cAAc,EAClC,OAAO,EACP,SAAS,EACT,UAAU,EACV,eAAe,EACf,UAAU,EACV,WAAW,EACA;IACX,MAAM,UAAU,MAAM,IAAA,mHAAI;IAC1B,IAAI,CAAC,SAAS,MAAM,MAAM,IAAI,MAAM;IAEpC,MAAM,SAAS,QAAQ,GAAG,CAAC,4BAA4B;IACvD,IAAI,CAAC,QAAQ;QACX,OAAO;YACL,YAAY;YACZ,aAAa;YACb,YAAY;QACd;IACF;IAEA,MAAM,QAAQ,IAAI,oLAAkB,CAAC;IACrC,sEAAsE;IACtE,MAAM,QAAQ,MAAM,kBAAkB,CAAC;QACrC,OAAO;QACP,wDAAwD;QACxD,mBAAmB,aACf,CAAC,kCAAkC,EAAE,WAAW,WAAW,EAAE,gBAAgB,CAAC,CAAC,GAC/E,CAAC,mFAAmF,CAAC;IAC3F;IAEA,IAAI;QACF,MAAM,QAAe;YACnB;gBAAE,MAAM,CAAC,iBAAiB,EAAE,WAAW;YAAC;YACxC;gBAAE,MAAM,CAAC,oBAAoB,EAAE,WAAW,wCAAwC;YAAC;SACpF;QAED,IAAI,eAAe,YAAY,QAAQ,CAAC,MAAM;YAC5C,MAAM,IAAI,CAAC;gBACT,YAAY;oBAAE,MAAM,YAAY,KAAK,CAAC,IAAI,CAAC,EAAE;oBAAE,UAAU;gBAAY;YACvE;QACF;QAEA,IAAI;QACJ,IAAI,UAAU;QACd,MAAM,aAAa;QAEnB,MAAO,WAAW,WAAY;YAC5B,IAAI;gBACF,SAAS,MAAM,MAAM,eAAe,CAAC;oBACnC,UAAU;wBAAC;4BAAE,MAAM;4BAAQ;wBAAM;qBAAE;oBACnC,kBAAkB;wBAChB,kBAAkB;wBAClB,gBAAgB;wBAChB,aAAa;oBACf;gBACF;gBACA;YACF,EAAE,OAAO,GAAQ;gBACf,IAAI,EAAE,MAAM,KAAK,OAAO,UAAU,YAAY;oBAC5C;oBACA,MAAM,MAAM,OAAO,UAAU,sBAAsB;oBACnD;gBACF;gBACA,MAAM;YACR;QACF;QAEA,MAAM,OAAO,QAAQ,UAAU;QAC/B,IAAI,CAAC,MAAM,MAAM,IAAI,MAAM;QAE3B,iEAAiE;QACjE,MAAM,OAAO,KAAK,KAAK,CAAC;QAExB,qCAAqC;QACrC,MAAM,SAAS,MAAM,gIAAa;QAClC,MAAM,KAAK,OAAO,EAAE,CAAC;QACrB,MAAM,GAAG,UAAU,CAAC,gBAAgB,SAAS,CAAC;YAC5C,QAAQ,QAAQ,IAAI,CAAC,EAAE;YACvB;YACA,aAAa;YACb,YAAY;YACZ,WAAW,IAAI;QACjB;QAEA,OAAO;IAET,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,wBAAwB;QAEtC,IAAI,MAAM,MAAM,KAAK,KAAK;YACxB,OAAO;gBACL,YAAY;gBACZ,aAAa;gBACb,YAAY;YACd;QACF;QAEA,OAAO;YACL,YAAY;YACZ,aAAa;YACb,YAAY;QACd;IACF;AACF;;;IAvGsB;;AAAA,+OAAA"}},
    {"offset": {"line": 252, "column": 0}, "map": {"version":3,"sources":["file:///D:/conversational-mirror-asd/.next-internal/server/app/%28dashboard%29/dashboard/generalchat/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {getAiResponse as '4075baf4163fd219b3dc28321f8b9138c3f8b5acc3'} from 'ACTIONS_MODULE0'\n"],"names":[],"mappings":";AAAA"}}]
}